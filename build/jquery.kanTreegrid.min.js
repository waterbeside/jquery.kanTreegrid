/*!
 jquery.kanTreegrid.js v1.0.0 | https://github.com/waterbeside/jquery.kanTreegrid.js (2017-06-02)
 Copyright (c) 簡(Kan) <waterbeside@126.com>
*/

!function(e){"use strict";var t={defaults:{idField:"id",treeField:"title",animate:!0,cache:!1,method:"get",deepStep:15,columns:[[{field:"id",title:"ID",width:"8%"},{field:"title",title:"名稱"}]]},init:function(a){var i=e.extend({},t.defaults,a);return t.target=this,this.each(function(){var t=e(this);t.kanTreegrid("setTreeContainer",e(this)),t.data("findCache",null),t.kanTreegrid("setSettings",i);var a=e(this).kanTreegrid("_domThead");e(this).html(a),e(this).append(e(this).kanTreegrid("_domTbodyWrap")),i.url?e(this).kanTreegrid("load",i.params):i.datas&&e(this).kanTreegrid("loadData",i.datas)})},load:function(t){var a=e(this),i=a.kanTreegrid("getSetting");e.ajax({type:i.method,dataType:"json",cache:i.cache,async:!1,data:t,url:i.url,beforeSend:function(){i.onBeforeLoad&&i.onBeforeLoad(i)},success:function(e){a.children("tbody").html(""),a.kanTreegrid("loadData",e)}})},reload:function(t){var a=e(this).kanTreegrid("getSetting"),i=void 0===a.params?t:e.extend({},a.params,t);e(this).kanTreegrid("load",i)},loadData:function(t){var a=e(this),i=a.kanTreegrid("getSetting");a.kanTreegrid("setData",t),a.kanTreegrid("_domTbody",{datas:t,deep:0}),a.children("tbody").children("tr").each(function(){var t=e(this),r=t.attr("data-id");e(this).find(".J-treeBtn").click(function(e){e.preventDefault(),e.stopPropagation(),t.hasClass("tree-collapsable")?a.kanTreegrid("collapse",r):a.kanTreegrid("expand",r)}),e(this).click(function(){var t=e(this).attr("data-id");a.kanTreegrid("select",t),"function"==typeof i.onClickRow&&i.onClickRow(a.kanTreegrid("getSelectedData"))})}),"function"==typeof i.onLoadSuccess&&i.onLoadSuccess(t)},getSetting:function(t){return e(this).kanTreegrid("getTreeContainer")?void 0===t?e(this).kanTreegrid("getTreeContainer").data("settings"):e(this).kanTreegrid("getTreeContainer").data("settings")[t]:null},setSettings:function(t){e(this).kanTreegrid("getTreeContainer").data("settings",t)},getTreeContainer:function(){return e(this).data("kanTreegrid")},setTreeContainer:function(t){return e(this).data("kanTreegrid",t)},setData:function(t){e(this).kanTreegrid("getTreeContainer").data("datas",t)},getData:function(){return e(this).kanTreegrid("getTreeContainer").data("datas")},setSelected:function(t){e(this).kanTreegrid("getTreeContainer").data("selected",t)},getSelected:function(){return e(this).kanTreegrid("getTreeContainer").data("selected")},select:function(t){var a=e(this).kanTreegrid("getSetting");if(!t)return!1;t=parseInt(t);var i=e(this).children("tbody").children("tr[data-id="+t+"]");i.addClass("J-datagrid-row-selected").siblings("tr").removeClass("J-datagrid-row-selected");var r=e(this).kanTreegrid("find",t);return e(this).kanTreegrid("setSelectedData",r),e(this).kanTreegrid("setSelected",i),"function"==typeof a.onSelect&&a.onSelect(e(this).kanTreegrid("getSelectedData")),i},unselect:function(t){void 0===t?e(this).children("tbody").children("tr").removeClass("J-datagrid-row-selected"):e(this).children("tbody").children("tr[data-id="+t+"]").removeClass("J-datagrid-row-selected"),e(this).kanTreegrid("setSelected",null)},setSelectedData:function(t){e(this).kanTreegrid("getTreeContainer").data("selectedDatas",t)},getSelectedData:function(){return e(this).kanTreegrid("getTreeContainer").data("selectedDatas")},find:function(t){var a=e(this).kanTreegrid("getData");return e(this).kanTreegrid("_find",t,a)},_find:function(t,a,i){var r=e(this),n=e(this).children("tbody").children("tr[data-id="+t+"]");return i=i||0,e(a).each(function(e,a){if(parseInt(a[r.kanTreegrid("getSetting","idField")])===parseInt(t))a.$node=n,r.data("findCache",a);else if(a.children&&a.children.length>0){var d=i+1;r.data("findCache",r.kanTreegrid("_find",t,a.children,d))}}),r.data("findCache")},_domThead:function(){for(var t=e(this).kanTreegrid("getSetting","columns")[0],a="<thead><tr>",i=0;i<t.length;i++)a+="<th "+(t[i].width?"width="+t[i].width:"")+">"+t[i].title+"</th>";return a+="</tr></thead>"},_domTbodyWrap:function(){return"<tbody></tbody>"},_domTbody:function(t){var a=void 0===t.deep?0:t.deep,i=e(this),r=i.kanTreegrid("getSetting","columns")[0],n=t.datas,d=i.children("tbody");e(n).each(function(e,t){for(var n="<tr "+(t.children.length>0?'class="tree-collapsable"':"")+' data-id="'+t[i.kanTreegrid("getSetting","idField")]+'" data-pid="'+t.parentid+'">',s=0;s<r.length;s++){var l=r[s].formatter?r[s].formatter(t[r[s].field],t):t[r[s].field];if(r[s].field===i.kanTreegrid("getSetting","treeField")){var o=t.children.length>0?'<span class="J-treeBtn"><i class="fa fa-folder-open"></i></span>':'<i class="fa fa-file-text-o"></i>';n+='<td class="treeField" field="'+r[s].field+'"><div class="cellwrap" style="padding-left:'+a*i.kanTreegrid("getSetting","deepStep")+'px">'+o+'&nbsp;<span class="cell">'+l+"</span></div></td>"}else n+='<td field="'+r[s].field+'"><div class="cellwrap"><span class="cell">'+l+"</span></div></td>"}if(n+="</tr>",d.append(n),t.children.length>0){var c=a+1,h={datas:t.children,deep:c};i.kanTreegrid("_domTbody",h)}})},collapseAll:function(){var t=this;t.children("tbody").children("tr.tree-collapsable").each(function(){var a=e(this).data("id");t.kanTreegrid("collapse",a)})},collapse:function(t){var a=this,i=e(this).children("tbody").children("tr[data-id="+t+"]"),r=e(this).children("tbody").children("tr[data-pid="+t+"]");i.hasClass("tree-collapsable")&&(i.removeClass("tree-collapsable").addClass("tree-expandable"),i.find(".J-treeBtn .fa").removeClass("fa-folder-open").addClass("fa-folder"),r.each(function(t){var i=e(this);a.kanTreegrid("getSetting","animate")?setTimeout(function(){i.hide()},50*t):i.hide(),e(this).attr("data-show","0");var r=e(this).data("id");a.kanTreegrid("_collapse",r)}))},_collapse:function(t){var a=this,i=e(this).children("tbody").children("tr[data-id="+t+"]"),r=e(this).children("tbody").children("tr[data-pid="+t+"]");r.length>0&&r.each(function(t){var r=e(this);i.hasClass("tree-collapsable")&&e(this).attr("data-show","1"),i.hasClass("tree-expandable")&&e(this).attr("data-show","0"),a.kanTreegrid("getSetting","animate")?setTimeout(function(){r.hide()},50*t):r.hide();var n=e(this).data("id");a.kanTreegrid("_collapse",n)})},expandAll:function(){var t=this;t.children("tbody").children("tr.tree-expandable").each(function(){var a=e(this).data("id");t.kanTreegrid("expand",a)})},expand:function(t){var a=this,i=e(this).children("tbody").children("tr[data-id="+t+"]"),r=e(this).children("tbody").children("tr[data-pid="+t+"]");i.hasClass("tree-expandable")&&(i.removeClass("tree-expandable").addClass("tree-collapsable"),i.find(".J-treeBtn .fa").addClass("fa-folder-open").removeClass("fa-folder"),r.each(function(t){var i=e(this),r=e(this).data("id");e(this).attr("data-show","1"),a.kanTreegrid("getSetting","animate")?setTimeout(function(){i.show()},50*t):i.show(),a.kanTreegrid("_expand",r)}))},_expand:function(t){var a=this;e(this).children("tbody").children("tr[data-pid="+t+"]").each(function(t){var i=e(this);if("1"===e(this).attr("data-show")){if(e(this).hasClass("tree-collapsable")){var r=e(this).data("id");a.kanTreegrid("_expand",r)}a.kanTreegrid("getSetting","animate")?setTimeout(function(){i.show()},50*t):i.show()}})}};e.fn.kanTreegrid=function(a){return t[a]?t[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof a&&a?void e.error("Method"+a+"does not exist on jQuery.kanTreegrid 。<br/> 方法"+a+"不存在於jQuery.kanTreegrid也！"):t.init.apply(this,arguments)}}(jQuery);
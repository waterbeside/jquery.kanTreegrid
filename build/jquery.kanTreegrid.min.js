/*!
 jquery.kanTreegrid.js v1.0.0 | https://github.com/waterbeside/jquery.kanTreegrid.js (2018-07-23)
 Copyright (c) 簡(Kan) <waterbeside@126.com>
*/

!function(s){"use strict";var t={defaults:{idField:"id",treeField:"title",pidField:"pid",animate:!0,cache:!1,method:"get",deepStep:15,columns:[[{field:"id",title:"ID",width:"8%"},{field:"title",title:"名稱"}]]},init:function(e){var a=s.extend({},t.defaults,e);return(t.target=this).each(function(){var e=s(this);e.kanTreegrid("setTreeContainer",s(this)),e.data("findCache",null),e.kanTreegrid("setSettings",a);var t=s(this).kanTreegrid("_domThead");s(this).html(t),s(this).append(s(this).kanTreegrid("_domTbodyWrap")),a.url?s(this).kanTreegrid("load",a.params):a.datas&&s(this).kanTreegrid("loadData",a.datas)})},load:function(e){var t=s(this),a=t.kanTreegrid("getSetting");s.ajax({type:a.method,dataType:"json",cache:a.cache,async:!1,data:e,url:a.url,beforeSend:function(){a.onBeforeLoad&&a.onBeforeLoad(a)},success:function(e){t.children("tbody").html(""),t.kanTreegrid("loadData",e)}})},reload:function(e){var t=s(this).kanTreegrid("getSetting"),a=void 0===t.params?e:s.extend({},t.params,e);s(this).kanTreegrid("load",a)},loadData:function(e){var i=s(this),r=i.kanTreegrid("getSetting");i.kanTreegrid("setData",e),i.kanTreegrid("_domTbody",{datas:e,deep:0}),i.children("tbody").children("tr").each(function(){var t=s(this),a=t.attr("data-id");s(this).find(".J-treeBtn").click(function(e){e.preventDefault(),e.stopPropagation(),t.hasClass("tree-collapsable")?i.kanTreegrid("collapse",a):i.kanTreegrid("expand",a)}),s(this).click(function(){var e=s(this).attr("data-id");i.kanTreegrid("select",e),"function"==typeof r.onClickRow&&r.onClickRow(i.kanTreegrid("getSelectedData"))})}),"function"==typeof r.onLoadSuccess&&r.onLoadSuccess(e)},getSetting:function(e){return s(this).kanTreegrid("getTreeContainer")?void 0===e?s(this).kanTreegrid("getTreeContainer").data("settings"):s(this).kanTreegrid("getTreeContainer").data("settings")[e]:null},setSettings:function(e){s(this).kanTreegrid("getTreeContainer").data("settings",e)},getTreeContainer:function(){return s(this).data("kanTreegrid")},setTreeContainer:function(e){return s(this).data("kanTreegrid",e)},setData:function(e){s(this).kanTreegrid("getTreeContainer").data("datas",e)},getData:function(){return s(this).kanTreegrid("getTreeContainer").data("datas")},setSelected:function(e){s(this).kanTreegrid("getTreeContainer").data("selected",e)},getSelected:function(){return s(this).kanTreegrid("getTreeContainer").data("selected")},select:function(e){var t=s(this).kanTreegrid("getSetting");if(!e)return!1;e=parseInt(e);var a=s(this).children("tbody").children("tr[data-id="+e+"]");a.addClass("J-datagrid-row-selected").siblings("tr").removeClass("J-datagrid-row-selected");var i=s(this).kanTreegrid("find",e);return s(this).kanTreegrid("setSelectedData",i),s(this).kanTreegrid("setSelected",a),"function"==typeof t.onSelect&&t.onSelect(s(this).kanTreegrid("getSelectedData")),a},unselect:function(e){void 0===e?s(this).children("tbody").children("tr").removeClass("J-datagrid-row-selected"):s(this).children("tbody").children("tr[data-id="+e+"]").removeClass("J-datagrid-row-selected"),s(this).kanTreegrid("setSelected",null)},setSelectedData:function(e){s(this).kanTreegrid("getTreeContainer").data("selectedDatas",e)},getSelectedData:function(){return s(this).kanTreegrid("getTreeContainer").data("selectedDatas")},find:function(e){var t=s(this).kanTreegrid("getData");return s(this).kanTreegrid("_find",e,t)},_find:function(i,e,r){var d=s(this),n=s(this).children("tbody").children("tr[data-id="+i+"]");return r=r||0,s(e).each(function(e,t){if(parseInt(t[d.kanTreegrid("getSetting","idField")])===parseInt(i))t.$node=n,d.data("findCache",t);else if(t.children&&0<t.children.length){var a=r+1;d.data("findCache",d.kanTreegrid("_find",i,t.children,a))}}),d.data("findCache")},_domThead:function(){for(var e=s(this).kanTreegrid("getSetting","columns")[0],t="<thead><tr>",a=0;a<e.length;a++)t+="<th "+(e[a].width?"width="+e[a].width:"")+">"+e[a].title+"</th>";return t+="</tr></thead>"},_domTbodyWrap:function(){return"<tbody></tbody>"},_domTbody:function(e){var l=void 0===e.deep?0:e.deep,o=s(this),c=o.kanTreegrid("getSetting","columns")[0],t=e.datas,h=o.children("tbody");s(t).each(function(e,t){for(var a="<tr "+(0<t.children.length?'class="tree-collapsable"':"")+' data-id="'+t[o.kanTreegrid("getSetting","idField")]+'" data-pid="'+t[o.kanTreegrid("getSetting","pidField")]+'" data-deep="'+l+'">',i=0;i<c.length;i++){var r=c[i].formatter?c[i].formatter(t[c[i].field],t):t[c[i].field];if(c[i].field===o.kanTreegrid("getSetting","treeField")){var d=0<t.children.length?'<span class="J-treeBtn"><i class="fa fa-folder-open"></i></span>':'<i class="fa fa-file-text-o"></i>';a+='<td class="treeField" field="'+c[i].field+'"><div class="cellwrap" style="padding-left:'+l*o.kanTreegrid("getSetting","deepStep")+'px">'+d+'&nbsp;<span class="cell">'+r+"</span></div></td>"}else a+='<td field="'+c[i].field+'"><div class="cellwrap"><span class="cell">'+r+"</span></div></td>"}if(a+="</tr>",h.append(a),0<t.children.length){var n=l+1,s={datas:t.children,deep:n};o.kanTreegrid("_domTbody",s)}})},collapseAll:function(){var t=this;t.children("tbody").children("tr.tree-collapsable").each(function(){var e=s(this).data("id");t.kanTreegrid("collapse",e)})},collapse:function(e){var i=this,t=s(this).children("tbody").children("tr[data-id="+e+"]"),a=s(this).children("tbody").children("tr[data-pid="+e+"]");t.hasClass("tree-collapsable")&&(t.removeClass("tree-collapsable").addClass("tree-expandable"),t.find(".J-treeBtn .fa").removeClass("fa-folder-open").addClass("fa-folder"),a.each(function(e){var t=s(this);i.kanTreegrid("getSetting","animate")?setTimeout(function(){t.hide()},50*e):t.hide(),s(this).attr("data-show","0");var a=s(this).data("id");i.kanTreegrid("_collapse",a)}))},_collapse:function(e){var i=this,r=s(this).children("tbody").children("tr[data-id="+e+"]"),t=s(this).children("tbody").children("tr[data-pid="+e+"]");0<t.length&&t.each(function(e){var t=s(this);r.hasClass("tree-collapsable")&&s(this).attr("data-show","1"),r.hasClass("tree-expandable")&&s(this).attr("data-show","0"),i.kanTreegrid("getSetting","animate")?setTimeout(function(){t.hide()},50*e):t.hide();var a=s(this).data("id");i.kanTreegrid("_collapse",a)})},expandAll:function(){var t=this;t.children("tbody").children("tr.tree-expandable").each(function(){var e=s(this).data("id");t.kanTreegrid("expand",e)})},expand:function(e){var i=this,t=s(this).children("tbody").children("tr[data-id="+e+"]"),a=s(this).children("tbody").children("tr[data-pid="+e+"]");t.hasClass("tree-expandable")&&(t.removeClass("tree-expandable").addClass("tree-collapsable"),t.find(".J-treeBtn .fa").addClass("fa-folder-open").removeClass("fa-folder"),a.each(function(e){var t=s(this),a=s(this).data("id");s(this).attr("data-show","1"),i.kanTreegrid("getSetting","animate")?setTimeout(function(){t.show()},50*e):t.show(),i.kanTreegrid("_expand",a)}))},_expand:function(e){var i=this;s(this).children("tbody").children("tr[data-pid="+e+"]").each(function(e){var t=s(this);if("1"===s(this).attr("data-show")){if(s(this).hasClass("tree-collapsable")){var a=s(this).data("id");i.kanTreegrid("_expand",a)}i.kanTreegrid("getSetting","animate")?setTimeout(function(){t.show()},50*e):t.show()}})}};s.fn.kanTreegrid=function(e){return t[e]?t[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?void s.error("Method"+e+"does not exist on jQuery.kanTreegrid 。<br/> 方法"+e+"不存在於jQuery.kanTreegrid也！"):t.init.apply(this,arguments)}}(jQuery);